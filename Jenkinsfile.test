stage('Test Backend') {
    steps {
        dir('backend') {
            sh '''
                echo "ğŸ”„ Setting up test environment..."
                npm install
                
                # Install test dependencies
                npm install --save-dev jest @types/jest ts-jest supertest @types/supertest
                
                # Create test configuration
                echo '{
                    "preset": "ts-jest",
                    "testEnvironment": "node",
                    "testTimeout": 10000,
                    "verbose": false,
                    "silent": true,
                    "collectCoverage": true,
                    "coverageThreshold": {
                        "global": {
                            "branches": 70,
                            "functions": 70,
                            "lines": 70
                        }
                    }
                }' > jest.config.json

                # Create test directory and basic tests
                mkdir -p __tests__
                
                # Create basic health check test
                echo 'describe("Health Check", () => {
                    test("Server is running", () => {
                        expect(true).toBe(true);
                    });
                });' > __tests__/health.test.ts

                # Run tests and capture output
                echo "ğŸ§ª Running tests..."
                TEST_OUTPUT=$(npm test 2>&1) || true
                
                # Generate summary report
                echo "
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                           TEST EXECUTION SUMMARY                           â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"

                if echo "$TEST_OUTPUT" | grep -q "PASS"; then
                    echo "â•‘ âœ… All Tests Passed                                                     â•‘"
                    RESULT="PASS"
                else
                    echo "â•‘ âŒ Some Tests Failed                                                    â•‘"
                    RESULT="FAIL"
                fi

                echo "â•‘                                                                           â•‘"
                echo "â•‘ Test Suites:                                                             â•‘"
                echo "$TEST_OUTPUT" | grep "Test Suites:" | while read -r line; do
                    printf "â•‘  %s%-65sâ•‘\\n" "  " "$line"
                done

                echo "â•‘                                                                           â•‘"
                echo "â•‘ Tests:                                                                    â•‘"
                echo "$TEST_OUTPUT" | grep "Tests:" | while read -r line; do
                    printf "â•‘  %s%-65sâ•‘\\n" "  " "$line"
                done

                echo "â•‘                                                                           â•‘"
                echo "â•‘ Coverage:                                                                 â•‘"
                echo "$TEST_OUTPUT" | grep "All files" | while read -r line; do
                    printf "â•‘  %s%-65sâ•‘\\n" "  " "$line"
                done
                
                echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

                if [ "$RESULT" = "FAIL" ]; then
                    exit 1
                fi
            '''
        }
    }
}

